---
name: refactoring-branch-setup
category: other
description: Template for Refactoring Branch Setup
tags: []
author: FallingAKS
created_at: '2026-02-18'
updated_at: '2026-02-18'
version: 1.0.0
kse_version: 3.0.2
---

# Moqui 重构分支设置 - 需求文档

**Spec ID**: {{SPEC_NAME}}  
**创建日期**: 2026-02-01  
**状态**: Approved  
**优先级**: High

---

## 1. 概述

### 1.1 目标

在当前稳定的 Moqui 系统基础上，创建一个新的 Git 分支，用于推进重大重构计划：
- 删除所有 Groovy 代码，改用纯 Java
- 从 Gradle 迁移到 Maven
- 实现前后端分离部署
- 使用 JWT 进行身份认证和授权

### 1.2 当前系统状态（基线）

**系统版本**: Moqui Framework 3.1.0-rc2  
**构建工具**: Gradle  
**主要语言**: Java + Groovy  
**部署方式**: 单体应用（WAR）  
**认证方式**: Session-based

**组件状态**:
- ✅ Moqui Framework (核心)
- ✅ tools 组件（完整）
- ✅ webroot 组件
- ✅ HiveMind（项目管理）
- ✅ ManbleERP（制造 ERP）
- ✅ PopCommerce（电商 ERP）
- ✅ SimpleScreens（手持仓库）
- ✅ mantle-udm（数据模型）
- ✅ mantle-usl（服务层）
- ✅ moqui-fop（PDF 生成）

**功能状态**:
- ✅ 系统正常启动（14-15 秒）
- ✅ Web UI 可访问（http://localhost:8080）
- ✅ 所有菜单正常显示
- ✅ 用户认证正常（john.doe / moqui）
- ✅ 权限系统正常工作

---

## 2. 用户故事

### 2.1 分支管理

**作为** 项目管理员  
**我想要** 创建一个新的 Git 分支来进行重构工作  
**以便** 保留当前稳定版本作为基线，同时安全地进行重大架构变更

**验收标准**:
- [ ] 当前 master 分支已打上基线标签（baseline-v1.0）
- [ ] 创建新分支 refactor/java-maven-jwt
- [ ] 新分支包含完整的当前代码
- [ ] 分支策略文档已创建
- [ ] 团队成员了解分支用途和规则

### 2.2 基线文档

**作为** 开发人员  
**我想要** 详细的基线文档  
**以便** 了解重构前的系统状态，作为对比和回退的参考

**验收标准**:
- [ ] 基线文档包含系统架构概览
- [ ] 记录所有组件及其版本
- [ ] 记录关键配置文件位置
- [ ] 记录已知问题和解决方案
- [ ] 记录性能基准数据（启动时间、内存占用等）

### 2.3 重构路线图

**作为** 技术负责人  
**我想要** 清晰的重构路线图  
**以便** 团队能够按阶段、有计划地推进重构工作

**验收标准**:
- [ ] 路线图分为多个阶段（Phase）
- [ ] 每个阶段有明确的目标和交付物
- [ ] 定义了阶段之间的依赖关系
- [ ] 估算了每个阶段的工作量
- [ ] 识别了关键风险和缓解措施

---

## 3. 功能需求

### 3.1 Git 分支设置

#### 3.1.1 基线标签
- 在当前 master 分支创建标签：`baseline-v1.0`
- 标签描述包含：
  - 系统状态摘要
  - 主要组件版本
  - 已知问题列表
  - 创建日期和创建人

#### 3.1.2 重构分支
- 分支名称：`refactor/java-maven-jwt`
- 从 `baseline-v1.0` 标签创建
- 分支保护规则：
  - 禁止直接推送到 master
  - 重构分支允许 force push（初期）
  - 定期合并 master 的 bug 修复

#### 3.1.3 分支策略文档
创建 `BRANCHING_STRATEGY.md`，包含：
- 分支命名规范
- 合并策略
- 代码审查流程
- 冲突解决指南

### 3.2 基线文档

#### 3.2.1 系统快照文档
创建 `BASELINE_SNAPSHOT.md`，包含：

**系统信息**:
- Moqui 版本
- Java 版本
- Gradle 版本
- 数据库版本（H2）

**组件清单**:
- 每个组件的名称、版本、用途
- 组件之间的依赖关系
- 组件的配置文件位置

**配置文件**:
- MoquiConf.xml 位置和关键配置
- MoquiDevConf.xml 开发环境配置
- 数据库连接配置
- 日志配置

**性能基准**:
- 启动时间（冷启动、热启动）
- 内存占用（初始、峰值）
- 关键操作响应时间
- 数据库大小

**已知问题**:
- 模板文件缺失问题及解决方案
- tools 组件权限问题及解决方案
- 其他已知限制

#### 3.2.2 架构文档
创建 `BASELINE_ARCHITECTURE.md`，包含：

**整体架构**:
- 分层架构图
- 组件交互图
- 数据流图

**技术栈**:
- 后端：Java 17 + Groovy 3.0.19
- 构建：Gradle 7.x
- Web：Jetty 10.0.25
- 模板：FreeMarker 2.3.34
- 数据库：H2 2.3.232（开发）

**关键设计**:
- Entity 定义机制
- Service 定义机制
- Screen 定义机制
- 权限控制机制

### 3.3 重构路线图

#### 3.3.1 阶段划分

**Phase 1: 准备和分析（1-2 周）**
- 创建分支和基线文档
- 分析 Groovy 代码使用情况
- 识别 Gradle 到 Maven 的迁移点
- 设计 JWT 认证架构
- 设计前后端分离架构

**Phase 2: 构建系统迁移（2-3 周）**
- 创建 Maven 项目结构
- 迁移依赖管理
- 配置 Maven 插件
- 验证构建流程

**Phase 3: Groovy 到 Java 转换（4-6 周）**
- 转换 Service 层 Groovy 代码
- 转换工具类 Groovy 代码
- 转换测试代码
- 保持功能等价性

**Phase 4: 前后端分离（3-4 周）**
- 设计 RESTful API
- 实现 API 层
- 前端独立部署配置
- API 文档生成

**Phase 5: JWT 认证实现（2-3 周）**
- 实现 JWT 生成和验证
- 替换 Session 认证
- 实现 Token 刷新机制
- 权限系统适配

**Phase 6: 测试和优化（2-3 周）**
- 功能测试
- 性能测试
- 安全测试
- 文档完善

#### 3.3.2 里程碑

- **M1**: 基线建立和分支创建（Week 1）
- **M2**: Maven 构建成功（Week 4）
- **M3**: Groovy 代码清除完成（Week 10）
- **M4**: 前后端分离部署成功（Week 14）
- **M5**: JWT 认证上线（Week 17）
- **M6**: 重构完成，生产就绪（Week 20）

#### 3.3.3 风险识别

**高风险**:
- Groovy 动态特性难以用 Java 替代
- Maven 依赖冲突
- 前后端分离后的性能下降
- JWT 认证的安全漏洞

**中风险**:
- 测试覆盖不足导致功能回归
- 团队对新技术栈不熟悉
- 文档更新不及时

**低风险**:
- 开发环境配置问题
- 代码风格不统一

---

## 4. 非功能需求

### 4.1 兼容性
- 重构后的系统应保持与现有数据库的兼容性
- API 应提供向后兼容的版本控制

### 4.2 性能
- 启动时间不应超过当前基线的 120%
- API 响应时间应在 200ms 以内（P95）
- 内存占用不应超过当前基线的 150%

### 4.3 安全性
- JWT Token 应使用 RS256 算法
- Token 有效期应可配置
- 应实现 Token 黑名单机制
- 应支持 HTTPS

### 4.4 可维护性
- 代码应遵循 Java 编码规范
- 应有完整的 JavaDoc
- 应有单元测试覆盖（目标 >70%）
- 应有集成测试

### 4.5 可部署性
- 前后端应可独立部署
- 应支持 Docker 容器化
- 应支持 Kubernetes 编排
- 应有完整的部署文档

---

## 5. 约束条件

### 5.1 技术约束
- 必须使用 Java 17 或更高版本
- 必须使用 Maven 3.8 或更高版本
- 必须使用 Spring Boot 3.x（如果引入 Spring）
- 数据库必须支持 H2（开发）和 PostgreSQL（生产）

### 5.2 时间约束
- 整个重构计划应在 5 个月内完成
- 每个 Phase 应按计划时间完成
- 关键里程碑不应延期超过 1 周

### 5.3 资源约束
- 开发团队规模：2-3 人
- 测试团队规模：1 人
- 不应影响现有系统的维护工作

---

## 6. 验收标准

### 6.1 分支设置
- [ ] Git 标签 `baseline-v1.0` 已创建
- [ ] 分支 `refactor/java-maven-jwt` 已创建
- [ ] 分支策略文档已完成
- [ ] 团队成员已培训

### 6.2 基线文档
- [ ] `BASELINE_SNAPSHOT.md` 已完成
- [ ] `BASELINE_ARCHITECTURE.md` 已完成
- [ ] 性能基准数据已收集
- [ ] 已知问题已记录

### 6.3 重构路线图
- [ ] 路线图文档已完成
- [ ] 所有 Phase 已定义
- [ ] 里程碑已设置
- [ ] 风险已识别和评估
- [ ] 团队已评审并同意

### 6.4 准备就绪
- [ ] 开发环境已配置
- [ ] CI/CD 流程已设置
- [ ] 代码仓库已准备
- [ ] 团队已准备好开始 Phase 1

---

## 7. 依赖关系

### 7.1 前置条件
- ✅ 当前系统处于稳定状态
- ✅ 所有组件已完整安装
- ✅ 系统能正常启动和运行
- ✅ 基本功能已验证

### 7.2 外部依赖
- Git 仓库访问权限
- CI/CD 平台（如 Jenkins、GitLab CI）
- 文档平台（如 Confluence、GitBook）
- 测试环境资源

---

## 8. 参考文档

- `.kiro/specs/03-00-baseline-verification/` - 基线验证文档
- `.kiro/specs/03-00-moqui-refactoring-master-plan/` - 重构总体规划
- `backend/MOQUI_ARCHITECTURE_GUIDE.md` - Moqui 架构指南
- `backend/MOQUI_QUICK_REFERENCE.md` - Moqui 快速参考

---

**文档版本**: 1.0  
**创建时间**: 2026-02-01  
**作者**: Kiro AI  
**状态**: 等待用户评审

---
name: baseline-verification
category: other
description: Template for Baseline Verification
tags: []
author: FallingAKS
created_at: '2026-02-18'
updated_at: '2026-02-18'
version: 1.0.0
kse_version: 3.0.2
---

# 系统基线验证 - 需求文档

**Spec ID**: {{SPEC_NAME}}  
**版本**: 1.1  
**创建日期**: {{DATE}}  
**优先级**: 最高（阻塞性）  
**状态**: 待执行

---

## 📋 概述

### 目的

在启动任何重构工作之前，必须验证当前 Moqui 系统处于正常可用状态。这个验证将作为后续所有修改的基准点（Baseline）。

### 价值

- ✅ 确保起点正确：避免在有问题的系统上进行重构
- ✅ 建立基准：为后续性能和功能对比提供参考
- ✅ 风险控制：及早发现和解决现有问题
- ✅ 信心保证：确保团队在稳定的基础上工作

---

## 🎯 用户故事

### US-1: 系统启动验证

**作为** 开发人员  
**我想要** 验证系统能够正常启动  
**以便** 确保基础环境配置正确

**验收标准**：
- [ ] 系统能够成功启动（无致命错误）
- [ ] 启动时间在合理范围内（< 5 分钟）
- [ ] 启动日志无 ERROR 级别错误
- [ ] 所有必要的服务和组件已加载

---

### US-2: 核心功能验证

**作为** 开发人员  
**我想要** 验证系统核心功能正常工作  
**以便** 确保业务逻辑完整可用

**验收标准**：
- [ ] 用户登录功能正常（john.doe / moqui）
- [ ] 主界面可以正常访问（http://localhost:8080/qapps）
- [ ] 核心业务模块可以访问（智能推荐、项目管理、系统管理）
- [ ] 数据库连接正常
- [ ] 基本 CRUD 操作正常

---

### US-3: API 功能验证

**作为** 开发人员  
**我想要** 验证 REST API 正常工作  
**以便** 确保前后端分离的基础已就绪

**验收标准**：
- [ ] REST API 端点可访问
- [ ] JWT 认证机制正常工作
- [ ] 典型 API 调用返回正确结果
- [ ] API 响应时间在合理范围内（< 2 秒）

---

### US-4: 数据库状态验证

**作为** 开发人员  
**我想要** 验证数据库状态正常  
**以便** 确保数据层完整可用

**验收标准**：
- [ ] 数据库连接正常
- [ ] 核心表结构完整
- [ ] 基础数据（种子数据）已加载
- [ ] 数据库查询性能正常

---

### US-5: 日志和监控验证

**作为** 开发人员  
**我想要** 验证日志和监控系统正常  
**以便** 确保问题可追踪和诊断

**验收标准**：
- [ ] 日志文件正常生成（runtime/log/）
- [ ] 日志级别配置正确
- [ ] 无异常堆栈信息（除已知问题外）
- [ ] 系统健康检查端点正常

---

## 📊 验证清单

### 环境验证

| 检查项 | 要求 | 验证方法 |
|--------|------|----------|
| Java 版本 | Java 21 LTS | `java -version` |
| 内存 | 最低 8GB | 系统信息 |
| 磁盘空间 | 最低 10GB 可用 | 磁盘管理 |
| 端口可用性 | 8080 未被占用 | `netstat -ano \| findstr 8080` |

### 启动验证

| 检查项 | 预期结果 | 验证方法 |
|--------|----------|----------|
| Gradle 构建 | 成功 | `gradlew build` |
| 系统启动 | 成功，无 ERROR | `gradlew run` |
| 启动时间 | < 5 分钟 | 计时 |
| 进程状态 | 运行中 | 任务管理器 |

### 功能验证

| 检查项 | 预期结果 | 验证方法 |
|--------|----------|----------|
| 主页访问 | 200 OK | http://localhost:8080/qapps |
| 用户登录 | 成功 | john.doe / moqui |
| 智能推荐 | 可访问 | /qapps/marketplace |
| 项目管理 | 可访问 | /qapps/tools |
| 系统管理 | 可访问 | /qapps/system |

### API 验证

| 检查项 | 预期结果 | 验证方法 |
|--------|----------|----------|
| REST API 端点 | 可访问 | /rest/s1/ |
| JWT 登录 | 返回 Token | POST /rest/s1/moqui/login |
| JWT 验证 | 认证成功 | 带 Token 的 API 调用 |
| API 响应 | < 2 秒 | 性能测试 |

### 数据库验证

| 检查项 | 预期结果 | 验证方法 |
|--------|----------|----------|
| 数据库连接 | 成功 | 日志检查 |
| H2 控制台 | 可访问 | http://localhost:8080/h2 |
| 核心表 | 存在 | SQL 查询 |
| 种子数据 | 已加载 | 数据检查 |

### 日志验证

| 检查项 | 预期结果 | 验证方法 |
|--------|----------|----------|
| moqui.log | 存在且更新 | runtime/log/moqui.log |
| error.log | 无新错误 | runtime/log/error.log |
| 日志级别 | INFO | 配置检查 |
| 异常堆栈 | 无（或已知） | 日志分析 |

---

## 🔍 验证步骤

### 步骤 1: 环境检查

```bash
# 检查 Java 版本
java -version

# 检查端口占用
netstat -ano | findstr 8080

# 检查磁盘空间
dir
```

**预期结果**：
- Java 版本 21.x
- 端口 8080 未被占用
- 磁盘空间充足

---

### 步骤 2: 构建验证

```bash
cd backend
gradlew clean build
```

**预期结果**：
- 构建成功
- 无编译错误
- 测试通过（如果有）

---

### 步骤 3: 启动系统

```bash
cd backend
gradlew run
```

**预期结果**：
- 系统成功启动
- 日志显示 "Moqui server started"
- 无 ERROR 级别日志

---

### 步骤 4: 功能测试

**4.1 访问主页**
- 打开浏览器：http://localhost:8080/qapps
- 预期：页面正常加载

**4.2 用户登录**
- 用户名：john.doe
- 密码：moqui
- 预期：登录成功，进入主界面

**4.3 模块访问**
- 访问智能推荐：/qapps/marketplace
- 访问项目管理：/qapps/tools
- 访问系统管理：/qapps/system
- 预期：所有模块可正常访问

---

### 步骤 5: API 测试

**5.1 JWT 登录**

```bash
curl -X POST http://localhost:8080/rest/s1/moqui/login \
  -H "Content-Type: application/json" \
  -d '{"username":"john.doe","password":"moqui"}'
```

**预期结果**：
- 返回 JWT Token
- 状态码 200

**5.2 API 调用**

```bash
curl -X GET http://localhost:8080/rest/s1/moqui/basic/info \
  -H "Authorization: Bearer <token>"
```

**预期结果**：
- 返回系统信息
- 状态码 200

---

### 步骤 6: 数据库检查

**6.1 访问 H2 控制台**
- URL: http://localhost:8080/h2
- 预期：可以访问数据库管理界面

**6.2 检查核心表**

```sql
-- 检查用户表
SELECT COUNT(*) FROM UserAccount;

-- 检查实体表
SELECT COUNT(*) FROM moqui.entity.EntityDefinition;
```

**预期结果**：
- 表存在且有数据
- 查询正常执行

---

### 步骤 7: 日志分析

**7.1 检查启动日志**

```bash
type backend\runtime\log\moqui.log | findstr "ERROR"
```

**预期结果**：
- 无 ERROR 或仅有已知的非致命错误

**7.2 检查错误日志**

```bash
type backend\runtime\log\error.log
```

**预期结果**：
- 文件为空或仅有历史错误

---

## 📈 性能基准

### 启动性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 启动时间 | < 5 分钟 | 从启动到 "server started" |
| 内存占用 | < 2GB | 任务管理器 |
| CPU 占用 | < 50%（稳定后） | 任务管理器 |

### 运行时性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 页面加载 | < 3 秒 | 浏览器开发工具 |
| API 响应 | < 2 秒 | curl 计时 |
| 数据库查询 | < 1 秒 | SQL 执行时间 |

---

## ✅ 验证通过标准

### 必须通过（阻塞性）

- [ ] 系统能够成功启动
- [ ] 用户可以正常登录
- [ ] 主要功能模块可访问
- [ ] 数据库连接正常
- [ ] 无致命错误日志

### 应该通过（警告性）

- [ ] 启动时间 < 5 分钟
- [ ] API 响应时间 < 2 秒
- [ ] 无 WARN 级别日志（或已知）
- [ ] 性能指标在合理范围

### 可以接受（信息性）

- [ ] 有少量非致命警告
- [ ] 性能略低于目标（但可用）
- [ ] 部分非核心功能有问题

---

## 🚨 问题处理

### 如果验证失败

1. **记录问题**：详细记录错误信息和日志
2. **分析原因**：确定是环境问题还是代码问题
3. **修复问题**：解决问题或调整验证标准
4. **重新验证**：确保问题已解决
5. **更新文档**：记录问题和解决方案

### 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 启动失败 | 端口占用 | 关闭占用进程或更改端口 |
| 内存不足 | JVM 配置 | 增加堆内存 `-Xmx4g` |
| 数据库错误 | 数据损坏 | 删除 runtime/db 重新初始化 |
| 登录失败 | 数据未初始化 | 检查种子数据加载 |

---

## 📝 交付物

### 验证报告

**必须包含**：
1. 验证环境信息（Java 版本、OS、内存等）
2. 验证步骤执行结果（通过/失败）
3. 性能基准数据
4. 发现的问题清单
5. 问题解决方案（如有）
6. 验证结论（通过/不通过）

### 基准数据

**必须记录**：
1. 启动时间
2. 内存占用
3. API 响应时间
4. 数据库查询时间
5. 日志文件大小

### 问题清单

**如有问题，必须记录**：
1. 问题描述
2. 严重程度（致命/警告/信息）
3. 复现步骤
4. 错误日志
5. 解决方案（如有）

---

## 🔗 相关文档

- [Moqui 架构指南](../../backend/MOQUI_ARCHITECTURE_GUIDE.md)
- [项目 README](../../backend/README.md)
- [重构主计划](../03-00-moqui-refactoring-master-plan/requirements.md)

---

## 🔄 重启补充（2026-02-14）

### 当前上下文

- 当前 `backend` 已切换为 Maven 多模块（`backend/pom.xml`）+ REST-only 运行形态。
- 启动流程以 `mvn clean package -DskipTests` + `java -jar app/target/app.jar` 为准。
- 当前有效入口为：`/health`、`/docs`、`/openapi.json`、`/api/v1/*`。
- 历史入口 `/qapps`、`/rest/s1/*`、`/h2` 在 REST-only 形态下不再作为通过标准（返回 404 视为架构差异，不单独判失败）。

### 验收标准（重启版）

#### 必须通过（阻塞性）

- [ ] Maven 构建成功（`mvn clean package -DskipTests`）
- [ ] 服务成功启动且健康检查通过（`GET /health` = 200）
- [ ] JWT 登录成功（`POST /api/v1/auth/login` 返回 token）
- [ ] 典型认证 API 调用成功（如 `/api/v1/auth/me`）
- [ ] 数据层可用（数据库文件存在，且可查询核心实体如 `moqui.security.UserAccount`）

#### 应该通过（警告性）

- [ ] 典型业务 API 响应时间 < 2 秒
- [ ] 基本 CRUD 烟测可通过（创建/查询/删除）
- [ ] 启动日志无新增 P1 级错误

#### 信息项（记录即可）

- [ ] 历史入口兼容性结果已记录（含 404 说明）
- [ ] 已记录已知非阻塞问题（如 ElasticSearch 未配置）

---

## 📝 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | {{DATE}} | Kiro AI | 初始版本 |
| 1.1 | 2026-02-14 | Codex | 重启补充：当前上下文与重启版验收标准 |

---

**下一步**：执行验证并生成验证报告

---
name: moqui-refactoring-master-plan
category: other
description: Template for Moqui Refactoring Master Plan
tags: []
author: FallingAKS
created_at: '2026-02-18'
updated_at: '2026-02-18'
version: 1.0.0
kse_version: 3.0.2
---

# Moqui 架构重构主计划 - 需求文档

**Spec ID**: {{SPEC_NAME}}  
**版本**: 1.0  
**创建日期**: {{DATE}}  
**状态**: 规划中

---

## 📋 项目概述

### 背景

当前 Moqui 系统存在以下问题：

1. **混乱的语言环境**：
   - XML（配置和页面定义）
   - Groovy（服务脚本，约 133 个文件）
   - Java（核心框架）
   - 三种语言混杂，增加了学习成本和维护难度

2. **调试困难**：
   - Groovy 脚本动态执行，难以调试
   - XML 中嵌入的逻辑难以追踪
   - 缺乏类型安全

3. **前后端耦合**：
   - 页面渲染和业务逻辑混在一起
   - 难以独立部署和扩展
   - 不利于现代化前端技术栈

### 目标

**主目标 1**: 从系统中安全去掉 Groovy，仅保留 Java  
**主目标 2**: 将原生 Moqui 前后端分离部署，使用 JWT 访问

### 价值

- ✅ **简化技术栈**：单一语言（Java），降低学习成本
- ✅ **提升可维护性**：类型安全，IDE 支持更好
- ✅ **改善调试体验**：标准 Java 调试工具
- ✅ **支持现代化架构**：前后端分离，微服务就绪
- ✅ **提升开发效率**：更好的工具链支持

---

## 🎯 核心需求

### 1. 语言统一（去 Groovy 化）

#### 1.1 Groovy 服务迁移

**需求描述**：将所有 Groovy 脚本服务迁移为 Java 实现

**当前状态**：
- Groovy 脚本文件：约 133 个
- 主要分布：
  - `mantle-usl/service/` - 业务服务
  - `framework/service/` - 框架服务
  - 测试文件（可保留）

**目标状态**：
- 所有业务服务使用 Java 实现
- 保留 XML 服务定义（仅作为接口声明）
- 测试文件可继续使用 Groovy（测试场景）

**验收标准**：
- [ ] 所有生产环境的 Groovy 服务已迁移为 Java
- [ ] 服务功能完全等价
- [ ] 所有单元测试通过
- [ ] 性能无明显下降（<5%）

#### 1.2 XML Actions 迁移

**需求描述**：将 XML 中嵌入的 Groovy 脚本迁移为 Java

**当前状态**：
- XML 中可能包含 `<actions>` 标签
- 使用 Groovy 模板：`XmlActions.groovy.ftl`

**目标状态**：
- XML 仅作为配置和声明
- 所有逻辑移至 Java 服务

**验收标准**：
- [ ] 识别所有包含逻辑的 XML 文件
- [ ] 逻辑提取为 Java 服务
- [ ] XML 简化为纯配置

#### 1.3 Groovy 运行时移除

**需求描述**：从系统中移除 Groovy 运行时依赖

**当前状态**：
- `build.gradle` 包含 Groovy 依赖
- 运行时配置 `GroovyScriptRunner`

**目标状态**：
- 移除 Groovy 依赖
- 移除 Groovy 运行时配置
- 保留必要的测试依赖（可选）

**验收标准**：
- [ ] `build.gradle` 不包含 Groovy 生产依赖
- [ ] 系统可正常启动和运行
- [ ] 所有功能测试通过

---

### 2. 前后端分离

#### 2.1 后端 API 化

**需求描述**：将后端改造为纯 REST API 服务

**当前状态**：
- 已有 REST API 支持（覆盖率约 70%）
- 已有 JWT 认证机制
- 部分功能仍依赖服务端渲染

**目标状态**：
- 100% REST API 覆盖
- 完全无状态（JWT 认证）
- 标准化 API 设计（RESTful）

**验收标准**：
- [ ] 所有业务功能提供 REST API
- [ ] API 文档完整（OpenAPI/Swagger）
- [ ] JWT 认证覆盖所有 API
- [ ] 支持跨域（CORS）配置

#### 2.2 前端独立部署

**需求描述**：前端应用可独立部署和访问

**当前状态**：
- 前端使用 XML Screen 定义
- 服务端渲染（FreeMarker）
- 已有 Electron 前端实践

**目标状态**：
- 前端完全独立
- 通过 JWT 访问后端 API
- 支持多种部署方式（Web、Electron、移动端）

**验收标准**：
- [ ] 前端可独立启动（不依赖后端渲染）
- [ ] 通过 HTTP API 与后端通信
- [ ] JWT Token 管理机制完善
- [ ] 支持 Token 刷新

#### 2.3 页面组件保留

**需求描述**：保留现有页面组件功能，但改为前端实现

**当前状态**：
- XML Screen 定义页面结构
- FreeMarker 模板渲染
- 组件功能完善

**目标状态**：
- 页面组件迁移为前端组件（Vue.js）
- 保持功能等价
- 改善用户体验

**验收标准**：
- [ ] 所有页面功能迁移完成
- [ ] UI/UX 保持一致或改进
- [ ] 响应速度提升
- [ ] 支持离线功能（PWA）

---

## 🚀 实施策略

### 两条主线并行

#### 主线 A：去 Groovy 化（语言统一）

**目标**：将系统从 Java + Groovy + XML 简化为 Java + XML（配置）

**优先级**：高  
**复杂度**：中高  
**风险**：中

**关键里程碑**：
1. Groovy 服务清单和分类
2. 核心服务迁移（20%）
3. 批量服务迁移（80%）
4. Groovy 运行时移除
5. 全面测试和验证

#### 主线 B：前后端分离

**目标**：将单体应用拆分为前后端独立部署

**优先级**：高  
**复杂度**：高  
**风险**：中高

**关键里程碑**：
1. API 完整性评估
2. 缺失 API 补充
3. 前端组件迁移
4. 独立部署验证
5. 性能和安全测试

### 依赖关系

```
主线 A（去 Groovy 化）
  ↓ 部分依赖
主线 B（前后端分离）
```

**说明**：
- 两条主线可以并行推进
- 主线 A 的完成会简化主线 B 的工作
- 但主线 B 不强依赖主线 A 完成

---

## 📊 风险评估

### 高风险项

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 功能遗漏 | 高 | 中 | 完整的功能清单和测试覆盖 |
| 性能下降 | 中 | 中 | 性能基准测试和优化 |
| 兼容性问题 | 高 | 低 | 渐进式迁移，保留回退方案 |
| 开发周期超期 | 中 | 高 | 分阶段交付，MVP 优先 |

### 中风险项

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 团队学习曲线 | 中 | 中 | 培训和文档支持 |
| 第三方依赖 | 中 | 低 | 依赖审查和替代方案 |
| 数据迁移 | 中 | 低 | 数据兼容性设计 |

---

## 🎯 成功标准

### 技术指标

- [ ] **代码质量**：SonarQube 评分 > 8.0
- [ ] **测试覆盖率**：单元测试 > 80%，集成测试 > 60%
- [ ] **性能**：响应时间 < 原系统 110%
- [ ] **稳定性**：无 P0/P1 级别 Bug

### 业务指标

- [ ] **功能完整性**：100% 功能迁移
- [ ] **用户体验**：用户满意度 > 85%
- [ ] **部署效率**：部署时间 < 30 分钟
- [ ] **可维护性**：新功能开发效率提升 30%

---

## 📅 时间规划

### 总体时间线

**预计总时长**：12-18 个月

**阶段划分**：

| 阶段 | 时长 | 主要工作 |
|------|------|----------|
| **阶段 1：调研和规划** | 1-2 个月 | 深度调研、方案设计、POC 验证 |
| **阶段 2：核心迁移** | 3-4 个月 | 核心服务迁移、API 补充 |
| **阶段 3：批量迁移** | 4-6 个月 | 批量服务迁移、前端组件迁移 |
| **阶段 4：优化和测试** | 2-3 个月 | 性能优化、全面测试 |
| **阶段 5：上线和稳定** | 2-3 个月 | 灰度发布、监控优化 |

---

## 🔗 相关文档

- [Moqui 架构指南](../../backend/MOQUI_ARCHITECTURE_GUIDE.md)
- [Moqui 快速参考](../../backend/MOQUI_QUICK_REFERENCE.md)
- [项目概览](../../backend/README.md)

---

## 📝 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | {{DATE}} | Kiro AI | 初始版本，主计划需求文档 |

---

**下一步**：创建详细的 Spec 路线图和各子 Spec 的需求文档
